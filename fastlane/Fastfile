# frozen_string_literal: true

default_platform(:ios)

# Helpers

def key_filepath
  File.expand_path('../Configuration/AppStoreConnect_API_Key.p8')
end

def application_xcconfig_filepath
  'Demo/Xcode/Shared/Targets/Application.xcconfig'
end

# Should be called before any operation requiring authentication (expires after 120 seconds)
#
# TODO: If build_app is updated to support a JSON API key path for automatic signing in the future (instead
#       of manually supplied xargs) we could remove this method and have the JSON passed to all fastlane actions
#       instead. This would be cleaner but currently we still need to duplicate the key as a .p8 file for build_app,
#       so there is no advantage in adopting the JSON API approach at the moment. See also:
#         https://docs.fastlane.tools/app-store-connect-api/#using-fastlane-api-key-hash-option
#         https://github.com/fastlane/fastlane/discussions/19973
def login_to_app_store_connect
  app_store_connect_api_key(
    key_id: ENV['KEY_ID'],
    issuer_id: ENV['KEY_ISSUER_ID'],
    key_filepath: key_filepath
  )
end

def xcconfig_marketing_version
  get_xcconfig_value(
    path: application_xcconfig_filepath,
    name: 'MARKETING_VERSION'
  )
end

def xcconfig_build_number
  get_xcconfig_value(
    path: application_xcconfig_filepath,
    name: 'CURRENT_PROJECT_VERSION'
  )
end

def bump_testflight_build_number(app_identifier)
  login_to_app_store_connect
  build_number = latest_testflight_build_number(
    app_identifier: app_identifier,
    platform: ENV['TESTFLIGHT_PLATFORM']
  ) + 1
  update_xcconfig_value(
    path: application_xcconfig_filepath,
    name: 'CURRENT_PROJECT_VERSION',
    value: build_number.to_s
  )
  build_number
end

def build_and_sign_app(configuration)
  build_app(
    project: 'Demo/Pillarbox-demo.xcodeproj',
    configuration: configuration,
    scheme: 'Pillarbox-demo',
    destination: "generic/platform=#{ENV['PLATFORM']}",
    export_team_id: ENV['TEAM_ID'],
    output_directory: 'Binaries',
    xcargs: "-authenticationKeyIssuerID #{ENV['KEY_ISSUER_ID']} -authenticationKeyID #{ENV['KEY_ID']} " \
            "-authenticationKeyPath #{key_filepath} -allowProvisioningUpdates"
  )
end

def add_version_badge(label, message, color)
  add_badge(
    no_badge: true,
    shield: "#{label}-#{message}-#{color}",
    shield_scale: ENV['SHIELD_SCALE'],
    shield_gravity: 'South',
    glob: ENV['ICON_GLOB']
  )
end

def changelog
  # Same formatters as git-log: https://git-scm.com/docs/pretty-formats
  changelog_from_git_commits(
    commits_count: 10,
    pretty: '- %s'
  )
end

def upload_app_to_testflight
  # FIXME: Temporary workaround for upload with Xcode 14, see https://github.com/fastlane/fastlane/issues/20371
  xcversion(version: '~> 13')
  login_to_app_store_connect
  upload_to_testflight
  xcversion(version: '~> 14')
end

# Requires `Beta App Information` and `Beta App Review Information` to have been properly filled once in TestFlight)
def distribute_app_to_testers(app_identifier, build_number)
  # FIXME: Temporary workaround for upload with Xcode 14, see https://github.com/fastlane/fastlane/issues/20371
  xcversion(version: '~> 13')
  login_to_app_store_connect
  upload_to_testflight(
    app_identifier: app_identifier,
    distribute_only: true,
    app_platform: ENV['TESTFLIGHT_PLATFORM'],
    build_number: build_number.to_s,
    distribute_external: true,
    changelog: changelog,
    groups: ENV['TESTFLIGHT_GROUPS'],
    notify_external_testers: true,
    demo_account_required: false
  )
  xcversion(version: '~> 14')
rescue StandardError => e
  raise e unless e.message.include?('Another build is in review')

  UI.important('TestFlight external delivery was skipped because a build is already in review')
end

def run_package_tests(scheme_name)
  run_tests(
    scheme: scheme_name,
    device: ENV['DEVICE'],
    package_path: '.',
    result_bundle: true,
    clean: true,
    fail_build: false
  )
  danger(
    danger_id: "#{scheme_name}-unit-tests",
    pr: 'https://github.com/SRGSSR/pillarbox-apple/pull/4',
    verbose: false
  )
  trainer(
    path: 'fastlane/test_output',
    output_remove_retry_attempts: true,
    fail_build: false,
  )
end

# Lanes

platform :ios do
  before_all do
    ensure_git_status_clean
    xcversion(version: '~> 14')
  end

  desc 'Deliver a demo app nightly build'
  lane :deliver_demo_nightly do
    app_identifier = 'ch.srgssr.Pillarbox-demo.nightly'
    build_number = bump_testflight_build_number(app_identifier)
    add_version_badge(xcconfig_marketing_version, build_number, 'orange')
    build_and_sign_app('Nightly')
    reset_git_repo(skip_clean: true)
    upload_app_to_testflight
    distribute_app_to_testers(app_identifier, build_number)
    reset_git_repo
  end

  desc 'Deliver a demo app release build'
  lane :deliver_demo_release do
    add_version_badge('Ver.', xcconfig_marketing_version, 'blue')
    build_and_sign_app('Release')
    reset_git_repo(skip_clean: true)
    upload_app_to_testflight
    distribute_app_to_testers('ch.srgssr.Pillarbox-demo', xcconfig_build_number)
    reset_git_repo
  end

  desc 'Build and run Appearance unit testse'
  lane :test_appearance do
    run_package_tests('Appearance')
  end

  desc 'Build and run CoreBusiness unit tests'
  lane :test_core_business do
    run_package_tests('CoreBusiness')
  end

  desc 'Build and run Diagnostics unit tests'
  lane :test_diagnostics do
    run_package_tests('Diagnostics')
  end

  desc 'Build and run Player unit tests'
  lane :test_player do
    run_package_tests('Player')
  end

  desc 'Build and run UserInterface unit tests'
  lane :test_user_interface do
    run_package_tests('UserInterface')
  end

  desc 'Danger'
  lane :run_danger do
    danger(
      danger_id: 'danger-test',
      pr: 'https://github.com/SRGSSR/pillarbox-apple/pull/4',
      verbose: false
    )
  end
end
